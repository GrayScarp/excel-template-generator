<!DOCTYPE html>
<html>
<head>
    <title>Excel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <script>
        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectName = urlParams.get('projectName') || 'Объект';
        const hashAlgorithm = urlParams.get('hashAlgorithm') || 'CRC-32';

        function generateExcel() {
            try {
                // Создаем рабочую книгу
                const wb = XLSX.utils.book_new();
                
                // Данные с объединенными ячейками
                const data = [
                    // Строка 1: A1-B1 объединены, C1-E1 объединены
                    ['Наименование объекта', '', projectName, '', ''],
                    // Строка 2: C2-D2 объединены
                    ['Номер п/п', 'Обозначение документа', 'Наименование документа', '', 'Номер последнего изменения (версии)'],
                    // Строка 3: C3-D3 объединены
                    ['1', '', '', '', '1'],
                    // Строка 4: A4-B4 объединены, C4-E4 объединены
                    [hashAlgorithm, '', '', '', ''],
                    // Строка 5: A5-B5 объединены
                    ['Наименование файла', '', 'Дата и время последнего изменения файла', 'Размер файла, байт', 'Значение контрольной суммы'],
                    // Строка 6: A6-B6 объединены
                    ['', '', '', '', ''],
                    // Строка 7: C7-D7 объединены
                    ['Характер работы', 'Фамилия', 'Подпись', '', 'Дата подписания'],
                    // Строка 8: C8-D8 объединены
                    ['Разработал', 'ФИО', '', '', ''],
                    // Строка 9: C9-D9 объединены
                    ['Проверил', 'ФИО', '', '', ''],
                    // Строка 10: C10-D10 объединены
                    ['ГИП', 'ФИО', '', '', ''],
                    // Строка 11: C11-D11 объединены
                    ['Утвердил', 'ФИО', '', '', ''],
                    // Строка 12: C12-D12 объединены
                    ['Согласовал', 'ФИО', '', '', ''],
                    // Строка 13: C13-D13 объединены
                    ['Согласовал', 'ФИО', '', '', ''],
                    // Строка 14: A14-A15 объединены, B14-C15 объединены
                    ['Информационно-удостоверяющий лист', '1_УЛ', '', 'Лист', 'Листов'],
                    // Строка 15
                    ['', '', '', '', '']
                ];

                // Создаем рабочий лист
                const ws = XLSX.utils.aoa_to_sheet(data);

                // Настраиваем объединение ячеек
                ws['!merges'] = [
                    // Строка 1
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }, // A1-B1
                    { s: { r: 0, c: 2 }, e: { r: 0, c: 4 } }, // C1-E1
                    
                    // Строка 2
                    { s: { r: 1, c: 2 }, e: { r: 1, c: 3 } }, // C2-D2
                    
                    // Строка 3
                    { s: { r: 2, c: 2 }, e: { r: 2, c: 3 } }, // C3-D3
                    
                    // Строка 4
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 1 } }, // A4-B4
                    { s: { r: 3, c: 2 }, e: { r: 3, c: 4 } }, // C4-E4
                    
                    // Строка 5
                    { s: { r: 4, c: 0 }, e: { r: 4, c: 1 } }, // A5-B5
                    
                    // Строка 6
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 1 } }, // A6-B6
                    
                    // Строка 7
                    { s: { r: 6, c: 2 }, e: { r: 6, c: 3 } }, // C7-D7
                    
                    // Строки 8-13
                    { s: { r: 7, c: 2 }, e: { r: 7, c: 3 } }, // C8-D8
                    { s: { r: 8, c: 2 }, e: { r: 8, c: 3 } }, // C9-D9
                    { s: { r: 9, c: 2 }, e: { r: 9, c: 3 } }, // C10-D10
                    { s: { r: 10, c: 2 }, e: { r: 10, c: 3 } }, // C11-D11
                    { s: { r: 11, c: 2 }, e: { r: 11, c: 3 } }, // C12-D12
                    { s: { r: 12, c: 2 }, e: { r: 12, c: 3 } }, // C13-D13
                    
                    // Строка 14
                    { s: { r: 13, c: 0 }, e: { r: 14, c: 0 } }, // A14-A15
                    { s: { r: 13, c: 1 }, e: { r: 14, c: 2 } }  // B14-C15
                ];

                // Настраиваем ширину колонок
                ws['!cols'] = [
                    { wch: 21.86 }, // A
                    { wch: 28.43 }, // B
                    { wch: 31.29 }, // C
                    { wch: 23.86 }, // D
                    { wch: 19.00 }  // E
                ];

                // Настраиваем высоту строк
                ws['!rows'] = [
                    { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 },
                    { hpt: 24 }, { hpt: 24 }, { hpt: 24 }, { hpt: 24 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }
                ];

                // Добавляем стили для жирного шрифта
                const boldCells = ['A1', 'C1', 'A2', 'B2', 'C2', 'E2', 'A5', 'C5', 'D5', 'E5', 'A7', 'B7', 'C7', 'E7'];
                boldCells.forEach(cell => {
                    if (ws[cell]) {
                        if (!ws[cell].s) ws[cell].s = {};
                        ws[cell].s.font = { bold: true };
                    }
                });

                // Добавляем лист в книгу
                XLSX.utils.book_append_sheet(wb, ws, "Удостоверяющий лист");

                // Генерируем и скачиваем файл
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                saveAs(blob, `УЛ_${projectName}.xlsx`);
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при создании файла: ' + error.message);
            }
        }

        // Запускаем генерацию
        generateExcel();
    </script>
</body>
</html>
