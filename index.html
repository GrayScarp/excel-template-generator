<!DOCTYPE html>
<html>
<head>
    <title>Excel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <script>
        function generateExcel() {
            try {
                // Получаем параметры из URL
                const urlParams = new URLSearchParams(window.location.search);
                const projectName = urlParams.get('projectName') || 'Объект';
                const hashAlgorithm = urlParams.get('hashAlgorithm') || 'CRC-32';

                // Создаем рабочую книгу
                const wb = XLSX.utils.book_new();
                
                // Данные
                const data = [
                    ['Наименование объекта', '', projectName, '', ''],
                    ['Номер п/п', 'Обозначение документа', 'Наименование документа', '', 'Номер последнего изменения (версии)'],
                    ['1', '', '', '', '1'],
                    [hashAlgorithm, '', '', '', ''],
                    ['Наименование файла', '', 'Дата и время последнего изменения файла', 'Размер файла, байт', 'Значение контрольной суммы'],
                    ['', '', '', '', ''],
                    ['Характер работы', 'Фамилия', 'Подпись', '', 'Дата подписания'],
                    ['Разработал', 'ФИО', '', '', ''],
                    ['Проверил', 'ФИО', '', '', ''],
                    ['ГИП', 'ФИО', '', '', ''],
                    ['Утвердил', 'ФИО', '', '', ''],
                    ['Согласовал', 'ФИО', '', '', ''],
                    ['Согласовал', 'ФИО', '', '', ''],
                    ['Информационно-удостоверяющий лист', '1_УЛ', '', 'Лист', 'Листов'],
                    ['', '', '', '', '']
                ];

                // Создаем рабочий лист
                const ws = XLSX.utils.aoa_to_sheet(data);

                // Настраиваем объединение ячеек
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }, { s: { r: 0, c: 2 }, e: { r: 0, c: 4 } },
                    { s: { r: 1, c: 2 }, e: { r: 1, c: 3 } },
                    { s: { r: 2, c: 2 }, e: { r: 2, c: 3 } },
                    { s: { r: 3, c: 0 }, e: { r: 3, c: 1 } }, { s: { r: 3, c: 2 }, e: { r: 3, c: 4 } },
                    { s: { r: 4, c: 0 }, e: { r: 4, c: 1 } },
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 1 } },
                    { s: { r: 6, c: 2 }, e: { r: 6, c: 3 } },
                    { s: { r: 7, c: 2 }, e: { r: 7, c: 3 } },
                    { s: { r: 8, c: 2 }, e: { r: 8, c: 3 } },
                    { s: { r: 9, c: 2 }, e: { r: 9, c: 3 } },
                    { s: { r: 10, c: 2 }, e: { r: 10, c: 3 } },
                    { s: { r: 11, c: 2 }, e: { r: 11, c: 3 } },
                    { s: { r: 12, c: 2 }, e: { r: 12, c: 3 } },
                    { s: { r: 13, c: 0 }, e: { r: 14, c: 0 } },
                    { s: { r: 13, c: 1 }, e: { r: 14, c: 2 } }
                ];

                // Настраиваем ширину колонок
                ws['!cols'] = [
                    { wch: 21.86 }, { wch: 28.43 }, { wch: 31.29 }, { wch: 23.86 }, { wch: 19.00 }
                ];

                // Настраиваем высоту строк
                ws['!rows'] = [
                    { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, 
                    { hpt: 20 }, { hpt: 20 }, { hpt: 24 }, { hpt: 24 }, { hpt: 24 }, 
                    { hpt: 24 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }, { hpt: 20 }
                ];

                // Добавляем стили для ячеек
                addStyleToRange(ws, 'A1:E1', { bold: true, wrapText: true });
                addStyleToRange(ws, 'A2:E2', { bold: true, wrapText: true });
                addStyleToRange(ws, 'A5:E5', { bold: true, wrapText: true });
                addStyleToRange(ws, 'A7:E7', { bold: true, wrapText: true });

                // Функция для добавления стилей к диапазону
                function addStyleToRange(worksheet, range, style) {
                    const rangeObj = XLSX.utils.decode_range(range);
                    
                    for (let R = rangeObj.s.r; R <= rangeObj.e.r; ++R) {
                        for (let C = rangeObj.s.c; C <= rangeObj.e.c; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                            if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
                            
                            if (style.bold) worksheet[cellAddress].s.font = { bold: true };
                            if (style.wrapText) {
                                if (!worksheet[cellAddress].s.alignment) worksheet[cellAddress].s.alignment = {};
                                worksheet[cellAddress].s.alignment.wrapText = true;
                            }
                        }
                    }
                }

                // Добавляем границы ко всем ячейкам
                addBordersToSheet(ws, 0, 14, 0, 4);

                function addBordersToSheet(worksheet, startRow, endRow, startCol, endCol) {
                    for (let R = startRow; R <= endRow; ++R) {
                        for (let C = startCol; C <= endCol; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                            if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
                            if (!worksheet[cellAddress].s.border) worksheet[cellAddress].s.border = {};
                            
                            worksheet[cellAddress].s.border.top = { style: 'thin' };
                            worksheet[cellAddress].s.border.left = { style: 'thin' };
                            worksheet[cellAddress].s.border.bottom = { style: 'thin' };
                            worksheet[cellAddress].s.border.right = { style: 'thin' };
                        }
                    }
                }

                // Добавляем лист в книгу
                XLSX.utils.book_append_sheet(wb, ws, "Удостоверяющий лист");

                // Генерируем файл
                const wbout = XLSX.write(wb, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    cellStyles: true 
                });
                
                const blob = new Blob([wbout], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                saveAs(blob, `УЛ_${projectName}.xlsx`);
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при создании файла: ' + error.message);
            }
        }

        // Запускаем генерацию
        generateExcel();
    </script>
</body>
</html>
