<!DOCTYPE html>
<html>
<head>
    <title>Excel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .excel-table {
            border-collapse: collapse;
            font-family: Calibri, Arial, sans-serif;
            font-size: 11px;
            table-layout: fixed;
            width: 800px;
            display: none;
        }
        .excel-table td {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: middle;
            word-wrap: break-word;
            white-space: normal;
        }
        .bold {
            font-weight: bold;
        }
        .col-a { width: 160px; }
        .col-b { width: 208px; }
        .col-c { width: 228px; }
        .col-d { width: 174px; }
        .col-e { width: 139px; }
        .row-20 { height: 20px; }
        .row-24 { height: 24px; }
    </style>
</head>
<body>
    <!-- Скрытая таблица для конвертации -->
    <table id="excelTable" class="excel-table">
        <!-- Строка 1 -->
        <tr class="row-20">
            <td colspan="2" class="col-a bold">Наименование объекта</td>
            <td colspan="3" class="col-c bold" id="projectNameCell">Объект</td>
        </tr>
        <!-- Строка 2 -->
        <tr class="row-20">
            <td class="col-a bold">Номер п/п</td>
            <td class="col-b bold">Обозначение документа</td>
            <td colspan="2" class="col-c bold">Наименование документа</td>
            <td class="col-e bold">Номер последнего изменения (версии)</td>
        </tr>
        <!-- Строка 3 -->
        <tr class="row-20">
            <td class="col-a">1</td>
            <td class="col-b"></td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e">1</td>
        </tr>
        <!-- Строка 4 -->
        <tr class="row-20">
            <td colspan="2" class="col-a" id="hashAlgorithmCell">CRC-32</td>
            <td colspan="3" class="col-c"></td>
        </tr>
        <!-- Строка 5 -->
        <tr class="row-20">
            <td colspan="2" class="col-a bold">Наименование файла</td>
            <td class="col-c bold">Дата и время последнего изменения файла</td>
            <td class="col-d bold">Размер файла, байт</td>
            <td class="col-e bold">Значение контрольной суммы</td>
        </tr>
        <!-- Строка 6 -->
        <tr class="row-20">
            <td colspan="2" class="col-a"></td>
            <td class="col-c"></td>
            <td class="col-d"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 7 -->
        <tr class="row-20">
            <td class="col-a bold">Характер работы</td>
            <td class="col-b bold">Фамилия</td>
            <td colspan="2" class="col-c bold">Подпись</td>
            <td class="col-e bold">Дата подписания</td>
        </tr>
        <!-- Строка 8 -->
        <tr class="row-24">
            <td class="col-a">Разработал</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 9 -->
        <tr class="row-24">
            <td class="col-a">Проверил</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 10 -->
        <tr class="row-24">
            <td class="col-a">ГИП</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 11 -->
        <tr class="row-24">
            <td class="col-a">Утвердил</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 12 -->
        <tr class="row-20">
            <td class="col-a">Согласовал</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 13 -->
        <tr class="row-20">
            <td class="col-a">Согласовал</td>
            <td class="col-b">ФИО</td>
            <td colspan="2" class="col-c"></td>
            <td class="col-e"></td>
        </tr>
        <!-- Строка 14 -->
        <tr class="row-20">
            <td rowspan="2" class="col-a">Информационно-удостоверяющий лист</td>
            <td rowspan="2" colspan="2" class="col-b">1_УЛ</td>
            <td class="col-d">Лист</td>
            <td class="col-e">Листов</td>
        </tr>
        <!-- Строка 15 -->
        <tr class="row-20">
            <td class="col-d"></td>
            <td class="col-e"></td>
        </tr>
    </table>

    <script>
        function generateExcel() {
            try {
                // Получаем параметры из URL
                const urlParams = new URLSearchParams(window.location.search);
                const projectName = urlParams.get('projectName') || 'Объект';
                const hashAlgorithm = urlParams.get('hashAlgorithm') || 'CRC-32';

                // Обновляем данные в таблице
                document.getElementById('projectNameCell').textContent = projectName;
                document.getElementById('hashAlgorithmCell').textContent = hashAlgorithm;

                // Показываем таблицу (нужно для конвертации)
                const table = document.getElementById('excelTable');
                table.style.display = 'table';

                // Конвертируем HTML таблицу в Excel
                const wb = XLSX.utils.table_to_book(table, { sheet: "Удостоверяющий лист" });

                // Настраиваем ширину колонок (дополнительная гарантия)
                if (!wb.Sheets['Удостоверяющий лист']['!cols']) {
                    wb.Sheets['Удостоверяющий лист']['!cols'] = [
                        { wch: 21.86 }, { wch: 28.43 }, { wch: 31.29 }, { wch: 23.86 }, { wch: 19.00 }
                    ];
                }

                // Генерируем и скачиваем файл
                const wbout = XLSX.write(wb, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    cellStyles: true 
                });
                
                const blob = new Blob([wbout], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                saveAs(blob, `УЛ_${projectName}.xlsx`);
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка при создании файла: ' + error.message);
            }
        }

        // Запускаем генерацию при загрузке
        window.onload = generateExcel;
    </script>
</body>
</html>
